<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script>
        // 检测是否为移动设备，如果是则跳转到移动版
        (function() {
            // 如果已经在移动版页面，不执行跳转
            if (window.location.pathname.includes('index-mobile.html')) {
                return;
            }
            
            var ua = navigator.userAgent || navigator.vendor || window.opera;
            var uaLower = ua.toLowerCase();
            
            // 检测iOS设备（包括iPhone、iPad、iPod）
            var isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
            // 检测Android设备
            var isAndroid = /android/i.test(uaLower);
            // 检测其他移动设备
            var isMobileDevice = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile|tablet/i.test(uaLower);
            // 检测屏幕尺寸（使用多种方法确保准确性）
            var isSmallScreen = (window.innerWidth && window.innerWidth <= 768) || 
                                (screen.width && screen.width <= 768) ||
                                (window.screen && window.screen.width && window.screen.width <= 768);
            
            // 如果是iOS设备、其他移动设备或屏幕宽度小于768px，跳转到移动版
            if (isIOS || isAndroid || isMobileDevice || isSmallScreen) {
                // 使用replace避免在历史记录中留下记录
                window.location.replace('index-mobile.html');
            }
        })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFE/TIME - 人生交易所</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root {
            --bg-base: #0b0e11;      /* 整体背景 */
            --bg-card: #1e2329;      /* 卡片背景 */
            --text-primary: #eaecef; /*主要文字 */
            --text-secondary: #848e9c; /* 次要文字 */
            --up-color: #0ecb81;     /* 涨/绿 */
            --down-color: #f6465d;   /* 跌/红 */
            --border-color: #2b3139; /* 边框 */
        }

        body {
            background-color: var(--bg-base);
            color: var(--text-primary);
            font-family: 'Binance Plex', 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            overflow: hidden; /* 类似App体验 */
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: var(--bg-base); }
        ::-webkit-scrollbar-thumb { background: #474d57; border-radius: 2px; }

        /* 模拟买卖盘口的列表 */
        .order-book-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .order-book-item:hover { 
            background-color: #2b3139;
            border-left-color: #f0b90b;
            padding-left: 12px;
        }
        .order-book-item.active {
            background-color: rgba(240, 185, 11, 0.1);
            border-left-color: #f0b90b;
        }

        /* 输入框样式重写 */
        .trade-input {
            background-color: #2b3139;
            border: 1px solid transparent;
            color: white;
            transition: all 0.2s;
        }
        .trade-input:focus { border-color: #f0b90b; }

        /* 按钮动画 */
        .btn-buy { background-color: var(--up-color); color: white; }
        .btn-sell { background-color: var(--down-color); color: white; }
        
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #f0b90b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 提示框样式 */
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1e2329 0%, #2b3139 100%);
            border: 1px solid #f0b90b;
            border-radius: 12px;
            padding: 30px 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 1000;
            min-width: 300px;
            text-align: center;
            animation: alertPop 0.3s ease-out;
        }
        @keyframes alertPop {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .custom-alert-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 999;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* 脉冲动画 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s ease-in-out infinite; }

        /* 行情滚动条 */
        .ticker-tape {
            background: #0b0e11;
            border-bottom: 1px solid #2b3139;
            overflow: hidden;
            height: 32px;
            position: relative;
        }
        .ticker-content {
            display: flex;
            animation: scroll-left 30s linear infinite;
            white-space: nowrap;
        }
        @keyframes scroll-left {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .ticker-item {
            padding: 0 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }

        /* 深度图样式 */
        .depth-bar {
            height: 3px;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.3;
        }
        .depth-bar.buy { background: var(--up-color); }
        .depth-bar.sell { background: var(--down-color); }

        /* 闪烁效果 */
        @keyframes blink-up {
            0%, 100% { background: transparent; }
            50% { background: rgba(14, 203, 129, 0.2); }
        }
        @keyframes blink-down {
            0%, 100% { background: transparent; }
            50% { background: rgba(246, 70, 93, 0.2); }
        }
        .blink-up { animation: blink-up 0.5s; }
        .blink-down { animation: blink-down 0.5s; }

        /* 淡入动画 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out;
        }

        /* 缩放按钮样式 */
        .zoom-controls {
            position: absolute;
            top: 50px;
            right: 20px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .zoom-btn {
            width: 32px;
            height: 32px;
            background: rgba(43, 49, 57, 0.9);
            border: 1px solid #2b3139;
            border-radius: 4px;
            color: #848e9c;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 16px;
            font-weight: bold;
        }
        .zoom-btn:hover {
            background: #2b3139;
            color: #f0b90b;
            border-color: #f0b90b;
        }

        /* 帮助面板 */
        .help-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1e2329 0%, #2b3139 100%);
            border: 1px solid #f0b90b;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 1000;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: alertPop 0.3s ease-out;
        }
        .help-section {
            margin-bottom: 20px;
        }
        .help-section h3 {
            color: #f0b90b;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .help-section ul {
            list-style: none;
            padding: 0;
        }
        .help-section li {
            color: #eaecef;
            font-size: 13px;
            line-height: 1.8;
            padding-left: 15px;
            position: relative;
        }
        .help-section li:before {
            content: "▸";
            position: absolute;
            left: 0;
            color: #0ecb81;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- 行情滚动条 -->
    <div class="ticker-tape">
        <div class="ticker-content" id="ticker-content">
            <!-- 动态生成 -->
        </div>
    </div>

    <header class="h-16 border-b border-[#2b3139] flex items-center px-4 bg-[#161a1e] flex-shrink-0">
        <div class="flex items-center gap-4 mr-8">
            <h1 class="text-xl font-bold text-white">LIFE / TIME</h1>
            <span class="text-xs bg-[#2b3139] px-2 py-0.5 rounded text-[#848e9c]">永续合约</span>
        </div>
        
        <div class="flex gap-6 text-xs">
            <div>
                <div class="text-[#0ecb81] font-medium text-2xl" id="current-score">60.00</div>
                <div class="text-[#848e9c] text-xs">当前运势 (Last Price)</div>
            </div>
            <div class="border-l border-[#2b3139] pl-6 space-y-1">
                <div class="flex items-center gap-2">
                    <span class="text-[#848e9c]">24h涨跌</span>
                    <span class="text-[#0ecb81] font-medium" id="price-change">+0.00%</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[#848e9c]">24h额</span>
                    <span class="text-white font-medium" id="turnover">0</span>
                </div>
            </div>
            <div class="border-l border-[#2b3139] pl-6 space-y-1">
                <div class="flex items-center gap-2">
                    <span class="text-[#848e9c]">24h高</span>
                    <span class="text-white font-medium" id="high-score">--</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[#848e9c]">24h低</span>
                    <span class="text-white font-medium" id="low-score">--</span>
                </div>
            </div>
            <div class="border-l border-[#2b3139] pl-6 space-y-1">
                <div class="flex items-center gap-2">
                    <span class="text-[#848e9c]">24h量</span>
                    <span class="text-white font-medium" id="vol-score">--</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-[#848e9c]">资金费率</span>
                    <span class="text-[#0ecb81] font-medium">+0.01%</span>
                </div>
            </div>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <div class="flex-1 flex flex-col relative border-r border-[#2b3139]">
            <div class="h-10 border-b border-[#2b3139] flex items-center px-4 gap-4 text-xs text-[#848e9c] bg-[#161a1e]">
                <span class="text-white cursor-pointer hover:text-[#f0b90b]">粒度</span>
                <span id="granularity-day" class="cursor-pointer hover:text-white" onclick="switchGranularity('day')">日K</span>
                <span id="granularity-month" class="cursor-pointer hover:text-white" onclick="switchGranularity('month')">月K</span>
                <span id="granularity-year" class="cursor-pointer hover:text-white text-[#f0b90b]" onclick="switchGranularity('year')">年K</span>
                <span class="text-[#848e9c]">|</span>
                <span class="text-white cursor-pointer hover:text-[#f0b90b]">周期</span>
                <span id="period-1y" class="cursor-pointer hover:text-white text-[#f0b90b]" onclick="switchPeriod('1y')">1年</span>
                <span id="period-10y" class="cursor-pointer hover:text-white" onclick="switchPeriod('10y')">10年</span>
                <span class="text-[#848e9c]">|</span>
                <span class="cursor-pointer hover:text-white">指标</span>
                <span id="indicator-ma" class="text-[#f0b90b] cursor-pointer" onclick="toggleIndicator('ma')">MA</span>
                <span id="indicator-ema" class="text-[#848e9c] cursor-pointer hover:text-white" onclick="toggleIndicator('ema')">EMA</span>
                <span id="indicator-boll" class="text-[#848e9c] cursor-pointer hover:text-white" onclick="toggleIndicator('boll')">BOLL</span>
            </div>

            <div id="kline-chart" class="w-full h-full bg-[#161a1e]"></div>

            <!-- 缩放控制按钮 -->
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()" title="放大 (滚轮上)">+</button>
                <button class="zoom-btn" onclick="zoomOut()" title="缩小 (滚轮下)">−</button>
                <button class="zoom-btn" onclick="resetZoom()" title="重置 (Z键)">⟲</button>
            </div>

            <div id="chart-loader" class="absolute inset-0 bg-[#0b0e11] z-50 flex flex-col items-center justify-center hidden">
                <div class="loader mb-4"></div>
                <div class="text-sm text-[#eaecef] mb-2">正在连接命运节点...</div>
                <div id="loading-tips" class="text-xs text-[#848e9c] max-w-xs text-center"></div>
            </div>
        </div>

        <div class="w-72 bg-[#161a1e] flex flex-col flex-shrink-0">
            
            <div class="p-4 border-b border-[#2b3139]">
                <div class="flex gap-2 mb-4 bg-[#0b0e11] p-1 rounded">
                    <button id="tab-bazi" class="flex-1 py-1 text-xs rounded bg-[#2b3139] text-white" onclick="switchTab('bazi')">八字排盘</button>
                    <button id="tab-ziwei" class="flex-1 py-1 text-xs rounded text-[#848e9c] hover:text-white" onclick="switchTab('ziwei')">紫微斗数</button>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] text-[#848e9c] mb-1 block">出生日期</label>
                        <input type="date" id="dob" value="1998-08-08" class="trade-input w-full p-2 rounded text-xs outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] text-[#848e9c] mb-1 block">出生时辰</label>
                        <select id="birth-hour" class="trade-input w-full p-2 rounded text-xs outline-none">
                            <option value="random">吉时 (Random)</option>
                            <option value="zi">子时 (23-01)</option>
                            <option value="chou">丑时 (01-03)</option>
                            <option value="yin">寅时 (03-05)</option>
                            <option value="mao">卯时 (05-07)</option>
                            <option value="chen">辰时 (07-09)</option>
                            <option value="si">巳时 (09-11)</option>
                            <option value="wu">午时 (11-13)</option>
                            <option value="wei">未时 (13-15)</option>
                            <option value="shen">申时 (15-17)</option>
                            <option value="you">酉时 (17-19)</option>
                            <option value="xu">戌时 (19-21)</option>
                            <option value="hai">亥时 (21-23)</option>
                        </select>
                    </div>
                    <button onclick="runSimulation()" class="w-full py-2.5 rounded bg-[#f0b90b] text-black font-bold text-sm hover:opacity-90 transition">
                        生成人生 K 线 (Space)
                    </button>
                    <button onclick="resetAll()" class="w-full py-1.5 rounded bg-[#2b3139] text-[#848e9c] text-xs hover:text-white transition">
                        重置所有设置
                    </button>
                </div>
            </div>

            <!-- 交易面板标签 -->
            <div class="flex border-b border-[#2b3139] text-xs bg-[#0b0e11]">
                <button id="tab-orderbook" class="flex-1 py-2 text-white border-b-2 border-[#f0b90b]" onclick="switchTradeTab('orderbook')">盘口</button>
                <button id="tab-trades" class="flex-1 py-2 text-[#848e9c] hover:text-white" onclick="switchTradeTab('trades')">成交</button>
                <button id="tab-position" class="flex-1 py-2 text-[#848e9c] hover:text-white" onclick="switchTradeTab('position')">持仓</button>
                <button id="tab-assets" class="flex-1 py-2 text-[#848e9c] hover:text-white" onclick="switchTradeTab('assets')">资产</button>
            </div>

            <!-- 订单簿 / 盘口深度 -->
            <div id="panel-orderbook" class="flex-1 flex flex-col overflow-hidden">
                <div id="order-book-header" class="px-4 py-2 text-xs text-[#848e9c] flex justify-between border-b border-[#2b3139]">
                    <span>年份/年龄</span>
                    <span>运势(Price)</span>
                    <span>事件(Event)</span>
                </div>
                
                <div id="order-book" class="flex-1 overflow-y-auto px-2 py-1 space-y-0.5">
                </div>
            </div>

            <!-- 最近成交 -->
            <div id="panel-trades" class="flex-1 flex-col overflow-hidden hidden">
                <div class="px-4 py-2 text-xs text-[#848e9c] flex justify-between border-b border-[#2b3139]">
                    <span>时间</span>
                    <span>价格</span>
                    <span>数量</span>
                </div>
                <div id="recent-trades" class="flex-1 overflow-y-auto px-2 py-1 space-y-0.5">
                </div>
            </div>

            <!-- 持仓信息 -->
            <div id="panel-position" class="flex-1 flex-col overflow-hidden p-4 hidden">
                <div class="space-y-3">
                    <div class="bg-[#1e2329] p-3 rounded">
                        <div class="text-xs text-[#848e9c] mb-2">当前持仓</div>
                        <div class="text-lg font-bold text-white" id="position-size">0</div>
                        <div class="text-xs text-[#848e9c] mt-1">单位：年份</div>
                    </div>
                    <div class="bg-[#1e2329] p-3 rounded">
                        <div class="text-xs text-[#848e9c] mb-2">持仓均价</div>
                        <div class="text-lg font-bold text-white" id="avg-price">--</div>
                    </div>
                    <div class="bg-[#1e2329] p-3 rounded">
                        <div class="text-xs text-[#848e9c] mb-2">未实现盈亏</div>
                        <div class="text-lg font-bold text-[#0ecb81]" id="unrealized-pnl">+0.00%</div>
                    </div>
                </div>
            </div>

            <!-- 资产信息 -->
            <div id="panel-assets" class="flex-1 flex-col overflow-hidden p-4 hidden">
                <div class="space-y-3">
                    <div class="bg-[#1e2329] p-3 rounded">
                        <div class="text-xs text-[#848e9c] mb-2">总资产</div>
                        <div class="text-lg font-bold text-white">10,000 USDT</div>
                    </div>
                    <div class="bg-[#1e2329] p-3 rounded">
                        <div class="text-xs text-[#848e9c] mb-2">可用保证金</div>
                        <div class="text-lg font-bold text-white">8,500 USDT</div>
                    </div>
                    <div class="bg-[#1e2329] p-3 rounded">
                        <div class="text-xs text-[#848e9c] mb-2">已用保证金</div>
                        <div class="text-lg font-bold text-white">1,500 USDT</div>
                    </div>
                    <div class="bg-[#1e2329] p-3 rounded">
                        <div class="text-xs text-[#848e9c] mb-2">今日盈亏</div>
                        <div class="text-lg font-bold text-[#0ecb81]">+125 USDT</div>
                    </div>
                </div>
            </div>

            <div class="p-3 border-t border-[#2b3139]">
                <div class="flex gap-2 mb-2">
                    <div class="flex-1">
                        <div class="text-[10px] text-[#848e9c] mb-1">杠杆</div>
                        <select class="w-full bg-[#2b3139] border-0 text-white text-xs p-1.5 rounded">
                            <option>1x</option>
                            <option>5x</option>
                            <option selected>10x</option>
                            <option>20x</option>
                            <option>50x</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <div class="text-[10px] text-[#848e9c] mb-1">数量</div>
                        <input type="number" class="w-full bg-[#2b3139] border-0 text-white text-xs p-1.5 rounded" placeholder="1" value="1">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="doLong()" class="flex-1 py-2 rounded bg-[#0ecb81] text-white text-xs font-bold hover:opacity-80 transition">
                        开多 Long
                    </button>
                    <button onclick="doShort()" class="flex-1 py-2 rounded bg-[#f6465d] text-white text-xs font-bold hover:opacity-80 transition">
                        开空 Short
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let chartInstance = null;
        let currentDataset = null;
        let currentPeriod = '1y';
        let currentGranularity = 'year'; // 'day', 'month', 'year'
        let activeIndicators = { ma: true, ema: false, boll: false };
        let currentTab = 'bazi';
        let currentBaziAnalysis = null; // 保存完整的八字分析结果
        let currentTradeTab = 'orderbook'; // 当前交易面板标签
        let recentTrades = []; // 最近成交记录
        let tickerData = []; // 行情数据
    
    // 核心配置：颜色变量
    const colors = {
        up: '#0ecb81',    // 绿
        down: '#f6465d',  // 红
        bg: '#161a1e',
        text: '#848e9c',
        grid: '#2b3139',
        ma7: '#f0b90b',   // 黄线
        ma25: '#d897cd',  // 紫线
        ma99: '#6885ce'   // 蓝线
    };

    // 计算均线 (Moving Average)
    function calculateMA(dayCount, data) {
        var result = [];
        for (var i = 0; i < data.length; i++) {
            if (i < dayCount) {
                result.push('-');
                continue;
            }
            var sum = 0;
            for (var j = 0; j < dayCount; j++) {
                sum += parseFloat(data[i - j][1]); // Close price
            }
            result.push((sum / dayCount).toFixed(2));
        }
        return result;
    }

    // 计算 EMA (Exponential Moving Average)
    function calculateEMA(dayCount, data) {
        var result = [];
        var multiplier = 2 / (dayCount + 1);
        var ema = null;
        
        for (var i = 0; i < data.length; i++) {
            var close = parseFloat(data[i][1]);
            if (ema === null) {
                ema = close;
            } else {
                ema = (close - ema) * multiplier + ema;
            }
            result.push(ema.toFixed(2));
        }
        return result;
    }

    // 计算布林带 (Bollinger Bands)
    function calculateBOLL(dayCount, data) {
        var ma = [];
        var upper = [];
        var lower = [];
        
        for (var i = 0; i < data.length; i++) {
            if (i < dayCount) {
                ma.push('-');
                upper.push('-');
                lower.push('-');
                continue;
            }
            
            var sum = 0;
            for (var j = 0; j < dayCount; j++) {
                sum += parseFloat(data[i - j][1]);
            }
            var average = sum / dayCount;
            
            var variance = 0;
            for (var j = 0; j < dayCount; j++) {
                variance += Math.pow(parseFloat(data[i - j][1]) - average, 2);
            }
            var stdDev = Math.sqrt(variance / dayCount);
            
            ma.push(average.toFixed(2));
            upper.push((average + 2 * stdDev).toFixed(2));
            lower.push((average - 2 * stdDev).toFixed(2));
        }
        
        return { ma, upper, lower };
    }

    // 天干地支数据（标准顺序）
    const tianGan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
    const diZhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
    const wuXing = {
        '甲': '木', '乙': '木', '丙': '火', '丁': '火', '戊': '土', '己': '土',
        '庚': '金', '辛': '金', '壬': '水', '癸': '水',
        '寅': '木', '卯': '木', '巳': '火', '午': '火', '辰': '土', '戌': '土', '丑': '土', '未': '土',
        '申': '金', '酉': '金', '亥': '水', '子': '水'
    };

    // 纳音表
    const naYinTable = {
        '甲子': '海中金', '乙丑': '海中金', '丙寅': '炉中火', '丁卯': '炉中火',
        '戊辰': '大林木', '己巳': '大林木', '庚午': '路旁土', '辛未': '路旁土',
        '壬申': '剑锋金', '癸酉': '剑锋金', '甲戌': '山头火', '乙亥': '山头火',
        '丙子': '涧下水', '丁丑': '涧下水', '戊寅': '城墙土', '己卯': '城墙土',
        '庚辰': '白蜡金', '辛巳': '白蜡金', '壬午': '杨柳木', '癸未': '杨柳木',
        '甲申': '泉中水', '乙酉': '泉中水', '丙戌': '屋上土', '丁亥': '屋上土',
        '戊子': '霹雳火', '己丑': '霹雳火', '庚寅': '松柏木', '辛卯': '松柏木',
        '壬辰': '长流水', '癸巳': '长流水', '甲午': '砂石金', '乙未': '砂石金',
        '丙申': '山下火', '丁酉': '山下火', '戊戌': '平地木', '己亥': '平地木',
        '庚子': '壁上土', '辛丑': '壁上土', '壬寅': '金箔金', '癸卯': '金箔金',
        '甲辰': '覆灯火', '乙巳': '覆灯火', '丙午': '天河水', '丁未': '天河水',
        '戊申': '大驿土', '己酉': '大驿土', '庚戌': '钗钏金', '辛亥': '钗钏金',
        '壬子': '桑松木', '癸丑': '桑松木', '甲寅': '大溪水', '乙卯': '大溪水',
        '丙辰': '沙中土', '丁巳': '沙中土', '戊午': '天上火', '己未': '天上火',
        '庚申': '石榴木', '辛酉': '石榴木', '壬戌': '大海水', '癸亥': '大海水'
    };

    // 计算纳音
    function getNaYin(gan, zhi) {
        const key = gan + zhi;
        return naYinTable[key] || '未知';
    }

    // 计算大运
    function calculateDaYun(yearGan, yearZhi, monthGan, monthZhi, gender, birthYear) {
        const daYunList = [];
        const ganList = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
        const zhiList = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
        
        // 简化版：阳男阴女顺排，阴男阳女逆排
        const yangGan = ['甲', '丙', '戊', '庚', '壬'];
        const isYangGan = yangGan.includes(yearGan);
        const isMale = gender === 'male' || Math.random() > 0.5; // 默认随机性别
        
        const isShun = (isYangGan && isMale) || (!isYangGan && !isMale);
        
        let currentGanIndex = ganList.indexOf(monthGan);
        let currentZhiIndex = zhiList.indexOf(monthZhi);
        
        // 起运岁数简化为8岁
        let startAge = 8;
        
        for (let i = 0; i < 8; i++) {
            if (isShun) {
                currentGanIndex = (currentGanIndex + 1) % 10;
                currentZhiIndex = (currentZhiIndex + 1) % 12;
            } else {
                currentGanIndex = (currentGanIndex - 1 + 10) % 10;
                currentZhiIndex = (currentZhiIndex - 1 + 12) % 12;
            }
            
            const gan = ganList[currentGanIndex];
            const zhi = zhiList[currentZhiIndex];
            const nayin = getNaYin(gan, zhi);
            const age = startAge + i * 10;
            const year = birthYear + age;
            
            daYunList.push({
                gan: gan,
                zhi: zhi,
                ganzhi: gan + zhi,
                nayin: nayin,
                age: age,
                year: year,
                range: `${age}-${age + 9}岁`
            });
        }
        
        return daYunList;
    }

    // 计算流年（使用精确算法）
    function calculateLiuNian(birthYear, currentYear) {
        const liuNianList = [];
        const startYear = Math.max(birthYear, currentYear - 5);
        const endYear = currentYear + 5;
        
        for (let year = startYear; year <= endYear; year++) {
            // 使用与年干支相同的精确计算
            const offset = year - 1864;
            const ganIndex = (offset % 10 + 10) % 10;
            const zhiIndex = (offset % 12 + 12) % 12;
            
            const gan = tianGan[ganIndex];
            const zhi = diZhi[zhiIndex];
            const nayin = getNaYin(gan, zhi);
            const age = year - birthYear;
            
            liuNianList.push({
                year: year,
                gan: gan,
                zhi: zhi,
                ganzhi: gan + zhi,
                nayin: nayin,
                age: age
            });
        }
        
        return liuNianList;
    }

    // ============ 精确八字计算算法 ============
    
    // 计算某年是否为闰年
    function isLeapYear(year) {
        return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
    }
    
    // 计算从基准日期到目标日期的天数
    function getDaysDiff(year, month, day) {
        // 使用1900年1月31日作为基准日（对应甲子日）
        const baseDate = new Date(1900, 0, 31);
        const targetDate = new Date(year, month - 1, day);
        const diffTime = targetDate - baseDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    }
    
    // 精确计算年干支（考虑立春节气）
    function getYearGanZhi(year, month, day) {
        // 简化处理：2月4日前后为立春分界
        let actualYear = year;
        if (month === 1 && day < 4) {
            actualYear = year - 1;
        }
        
        // 1864年是甲子年
        const offset = actualYear - 1864;
        const ganIndex = offset % 10;
        const zhiIndex = offset % 12;
        
        return {
            gan: tianGan[(ganIndex + 10) % 10],
            zhi: diZhi[(zhiIndex + 12) % 12],
            index: { gan: (ganIndex + 10) % 10, zhi: (zhiIndex + 12) % 12 }
        };
    }
    
    // 精确计算月干支（五虎遁月诀）
    function getMonthGanZhi(year, month, day, yearGanIndex) {
        // 节气月份对应表（简化版，按公历月份）
        // 实际应该按节气划分，这里简化处理
        let solarMonth = month;
        
        // 立春前算上一年
        if (month === 1 && day < 4) {
            solarMonth = 12;
        }
        
        // 月地支：寅月(立春)开始
        // 1月立春(寅), 2月惊蛰(卯), 3月清明(辰), 4月立夏(巳), 5月芒种(午), 6月小暑(未)
        // 7月立秋(申), 8月白露(酉), 9月寒露(戌), 10月立冬(亥), 11月大雪(子), 12月小寒(丑)
        const monthZhiMap = [11, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]; // 12月对应丑，1月对应寅...
        const zhiIndex = monthZhiMap[solarMonth];
        
        // 五虎遁月诀：甲己之年丙作首，乙庚之岁戊为头
        //             丙辛必定寻庚起，丁壬壬位顺行流
        //             若问戊癸何方发，甲寅之上好追求
        const monthGanStart = {
            0: 2, 4: 2,  // 甲、己年从丙开始
            1: 4, 5: 4,  // 乙、庚年从戊开始
            2: 6, 6: 6,  // 丙、辛年从庚开始
            3: 8, 7: 8,  // 丁、壬年从壬开始
            8: 0, 9: 0   // 戊、癸年从甲开始
        };
        
        const startGan = monthGanStart[yearGanIndex];
        const ganIndex = (startGan + zhiIndex) % 10;
        
        return {
            gan: tianGan[ganIndex],
            zhi: diZhi[zhiIndex],
            index: { gan: ganIndex, zhi: zhiIndex }
        };
    }
    
    // 精确计算日干支（基于基准日推算）
    function getDayGanZhi(year, month, day) {
        const days = getDaysDiff(year, month, day);
        
        // 1900年1月31日是甲子日
        const ganIndex = (days % 10 + 10) % 10;
        const zhiIndex = (days % 12 + 12) % 12;
        
        return {
            gan: tianGan[ganIndex],
            zhi: diZhi[zhiIndex],
            index: { gan: ganIndex, zhi: zhiIndex }
        };
    }
    
    // 精确计算时干支（五鼠遁日起时）
    function getHourGanZhi(dayGanIndex, birthHour) {
        // 时辰地支映射
        const hourZhiMap = {
            'zi': 0, 'chou': 1, 'yin': 2, 'mao': 3,
            'chen': 4, 'si': 5, 'wu': 6, 'wei': 7,
            'shen': 8, 'you': 9, 'xu': 10, 'hai': 11,
            'random': Math.floor(Math.random() * 12)
        };
        
        const zhiIndex = hourZhiMap[birthHour] !== undefined ? hourZhiMap[birthHour] : hourZhiMap['random'];
        
        // 五鼠遁日起时诀：甲己还加甲，乙庚丙作初
        //                 丙辛从戊起，丁壬庚子居
        //                 戊癸何方发，壬子是真途
        const hourGanStart = {
            0: 0, 5: 0,  // 甲、己日从甲子时开始
            1: 2, 6: 2,  // 乙、庚日从丙子时开始
            2: 4, 7: 4,  // 丙、辛日从戊子时开始
            3: 6, 8: 6,  // 丁、壬日从庚子时开始
            4: 8, 9: 8   // 戊、癸日从壬子时开始
        };
        
        const startGan = hourGanStart[dayGanIndex];
        const ganIndex = (startGan + zhiIndex) % 10;
        
        return {
            gan: tianGan[ganIndex],
            zhi: diZhi[zhiIndex],
            index: { gan: ganIndex, zhi: zhiIndex }
        };
    }
    
    // 主八字计算函数
    function analyzePattern(dob, birthHour) {
        const dateObj = new Date(dob);
        const year = dateObj.getFullYear();
        const month = dateObj.getMonth() + 1; // JavaScript月份是0-11，转为1-12
        const day = dateObj.getDate();
        
        // 精确计算年干支
        const yearGZ = getYearGanZhi(year, month, day);
        const yearGan = yearGZ.gan;
        const yearZhi = yearGZ.zhi;
        const yearGanIndex = yearGZ.index.gan;
        
        // 精确计算月干支
        const monthGZ = getMonthGanZhi(year, month, day, yearGanIndex);
        const monthGan = monthGZ.gan;
        const monthZhi = monthGZ.zhi;
        
        // 精确计算日干支
        const dayGZ = getDayGanZhi(year, month, day);
        const dayGan = dayGZ.gan;
        const dayZhi = dayGZ.zhi;
        const dayGanIndex = dayGZ.index.gan;
        
        // 精确计算时干支
        const hourGZ = getHourGanZhi(dayGanIndex, birthHour);
        const hourGan = hourGZ.gan;
        const hourZhi = hourGZ.zhi;
        
        // 获取日主五行
        const dayWuXing = wuXing[dayGan];
        const monthWuXing = wuXing[monthZhi];
        
        // 计算五行强弱（考虑天干地支权重）
        let wuXingCount = { '木': 0, '火': 0, '土': 0, '金': 0, '水': 0 };
        
        // 天干透出力量较大
        if (wuXing[yearGan]) wuXingCount[wuXing[yearGan]] += 1.0;
        if (wuXing[monthGan]) wuXingCount[wuXing[monthGan]] += 1.0;
        if (wuXing[dayGan]) wuXingCount[wuXing[dayGan]] += 2.0; // 日主最重要
        if (wuXing[hourGan]) wuXingCount[wuXing[hourGan]] += 1.0;
        
        // 地支根基力量
        if (wuXing[yearZhi]) wuXingCount[wuXing[yearZhi]] += 0.8;
        if (wuXing[monthZhi]) wuXingCount[wuXing[monthZhi]] += 1.2; // 月令最有力
        if (wuXing[dayZhi]) wuXingCount[wuXing[dayZhi]] += 0.8;
        if (wuXing[hourZhi]) wuXingCount[wuXing[hourZhi]] += 0.8;
        
        // 判断身强身弱（日主力量 vs 其他力量）
        const dayMainPower = wuXingCount[dayWuXing];
        const totalPower = Object.values(wuXingCount).reduce((a, b) => a + b, 0);
        const dayPowerRatio = dayMainPower / totalPower;
        
        // 日主力量占比超过35%为身强，低于25%为身弱
        const isStrong = dayPowerRatio > 0.35;
        const isWeak = dayPowerRatio < 0.25;
        
        // 根据月令和日主关系判定格局
        let patternResult = "";
        let godResult = "";
        
        // 格局判定逻辑
        const seasonPatterns = {
            '春': ['木'], '夏': ['火'], '秋': ['金'], '冬': ['水']
        };
        
        // 确定季节（按月支）
        let season = '';
        const springMonths = ['寅', '卯', '辰'];
        const summerMonths = ['巳', '午', '未'];
        const autumnMonths = ['申', '酉', '戌'];
        const winterMonths = ['亥', '子', '丑'];
        
        if (springMonths.includes(monthZhi)) season = '春';
        else if (summerMonths.includes(monthZhi)) season = '夏';
        else if (autumnMonths.includes(monthZhi)) season = '秋';
        else if (winterMonths.includes(monthZhi)) season = '冬';
        
        // ============ 更精确的格局判定系统 ============
        
        // 判断天干地支的十神关系（更详细）
        const getDetailShiShen = (dayGan, target) => {
            const wuXingA = wuXing[dayGan];
            const wuXingB = wuXing[target];
            
            // 五行生克关系
            const shengKe = {
                '木': { sheng: '火', ke: '土', keBy: '金', shengBy: '水' },
                '火': { sheng: '土', ke: '金', keBy: '水', shengBy: '木' },
                '土': { sheng: '金', ke: '水', keBy: '木', shengBy: '火' },
                '金': { sheng: '水', ke: '木', keBy: '火', shengBy: '土' },
                '水': { sheng: '木', ke: '火', keBy: '土', shengBy: '金' }
            };
            
            const yangGan = ['甲', '丙', '戊', '庚', '壬'];
            const isYangDay = yangGan.includes(dayGan);
            const isYangTarget = yangGan.includes(target);
            const sameYinYang = isYangDay === isYangTarget;
            
            if (wuXingA === wuXingB) {
                return sameYinYang ? '比肩' : '劫财';
            }
            if (shengKe[wuXingA].sheng === wuXingB) {
                return sameYinYang ? '食神' : '伤官';
            }
            if (shengKe[wuXingA].ke === wuXingB) {
                return sameYinYang ? '偏财' : '正财';
            }
            if (shengKe[wuXingA].keBy === wuXingB) {
                return sameYinYang ? '七杀' : '正官';
            }
            if (shengKe[wuXingA].shengBy === wuXingB) {
                return sameYinYang ? '偏印' : '正印';
            }
            return '未知';
        };
        
        // 简化版十神判断（用于分类）
        const getShiShen = (dayGan, target) => {
            const detail = getDetailShiShen(dayGan, target);
            if (detail === '比肩' || detail === '劫财') return '比劫';
            if (detail === '食神' || detail === '伤官') return '食伤';
            if (detail === '偏财' || detail === '正财') return '财星';
            if (detail === '七杀' || detail === '正官') return '官杀';
            if (detail === '偏印' || detail === '正印') return '印星';
            return '未知';
        };
        
        // 统计四柱中各十神的数量
        const shiShenCount = {
            '比劫': 0, '食伤': 0, '财星': 0, '官杀': 0, '印星': 0
        };
        const detailShiShenCount = {};
        
        [yearGan, yearZhi, monthGan, monthZhi, dayZhi, hourGan, hourZhi].forEach(item => {
            if (item !== dayGan) {
                const ss = getShiShen(dayGan, item);
                const dss = getDetailShiShen(dayGan, item);
                shiShenCount[ss] = (shiShenCount[ss] || 0) + 1;
                detailShiShenCount[dss] = (detailShiShenCount[dss] || 0) + 1;
            }
        });
        
        const monthShiShen = getShiShen(dayGan, monthZhi);
        const monthDetailShiShen = getDetailShiShen(dayGan, monthZhi);
        
        // ============ 根据月令十神和身强身弱判定格局 ============
        
        // 首先判断是否为特殊格局
        let isSpecialPattern = false;
        
        // 1. 从格判断（极弱格局）
        if (dayPowerRatio < 0.15) {
            if (shiShenCount['财星'] >= 3) {
                patternResult = "从财格 (舍命从财)";
                godResult = "喜财星食伤 / 忌印比";
                isSpecialPattern = true;
            } else if (shiShenCount['官杀'] >= 3) {
                patternResult = "从杀格 (弃命从杀)";
                godResult = "喜官杀财星 / 忌印比";
                isSpecialPattern = true;
            } else if (shiShenCount['食伤'] >= 3) {
                patternResult = "从儿格 (从食伤)";
                godResult = "喜食伤财星 / 忌印枭";
                isSpecialPattern = true;
            } else {
                patternResult = "从弱格 (随波逐流)";
                godResult = "喜顺不喜逆 / 宜顺势而为";
                isSpecialPattern = true;
            }
        }
        
        // 2. 专旺格判断（极强格局）
        if (!isSpecialPattern && dayPowerRatio > 0.6) {
            if (shiShenCount['比劫'] >= 4) {
                patternResult = "曲直格/炎上格/稼穑格/从革格/润下格 (专旺)";
                godResult = "喜比劫印星 / 忌财官食伤";
                isSpecialPattern = true;
            } else {
                patternResult = "专旺格 (一气专旺)";
                godResult = "喜印比 / 忌财官";
                isSpecialPattern = true;
            }
        }
        
        // 3. 化气格判断（天干五合化气）
        if (!isSpecialPattern) {
            const heHua = {
                '甲己': '土', '乙庚': '金', '丙辛': '水', '丁壬': '木', '戊癸': '火'
            };
            const yearDayHe = heHua[yearGan + dayGan] || heHua[dayGan + yearGan];
            const monthDayHe = heHua[monthGan + dayGan] || heHua[dayGan + monthGan];
            const hourDayHe = heHua[hourGan + dayGan] || heHua[dayGan + hourGan];
            
            if (yearDayHe || monthDayHe || hourDayHe) {
                const huaWuXing = yearDayHe || monthDayHe || hourDayHe;
                patternResult = `化气格 (化为${huaWuXing})`;
                godResult = `喜${huaWuXing}类 / 忌克${huaWuXing}之物`;
                isSpecialPattern = true;
            }
        }
        
        // 4. 正格判断（普通格局）
        if (!isSpecialPattern) {
            // 比劫格
            if (monthShiShen === '比劫') {
                if (monthDetailShiShen === '比肩') {
                    if (isStrong) {
                        patternResult = "建禄格 (比肩当令)";
                        godResult = "喜食伤泄秀 / 喜财星生发 / 忌印比";
                    } else {
                        patternResult = "阳刃格 (羊刃帮身)";
                        godResult = "喜官杀制刃 / 喜食伤泄秀";
                    }
                } else {
                    patternResult = "劫财格 (劫财当令)";
                    godResult = isStrong ? "喜食伤财星 / 忌印比" : "喜印比帮身 / 忌财官";
                }
            }
            // 食伤格
            else if (monthShiShen === '食伤') {
                if (monthDetailShiShen === '食神') {
                    if (isStrong) {
                        patternResult = "食神格 (食神吐秀)";
                        if (shiShenCount['财星'] >= 2) {
                            patternResult = "食神生财格";
                            godResult = "喜食伤生财 / 忌印夺食";
                        } else {
                            godResult = "喜财星 / 喜食神 / 忌枭印";
                        }
                    } else {
                        patternResult = "食神制杀格";
                        godResult = "喜食神制杀 / 喜印比帮身";
                    }
                } else {
                    // 伤官格
                    if (detailShiShenCount['正官'] >= 1) {
                        patternResult = "伤官见官格 (为祸百端)";
                        godResult = "喜财星通关 / 喜印制伤";
                    } else if (season === '夏' && dayWuXing === '水') {
                        patternResult = "伤官伤尽格 (水木伤官)";
                        godResult = "喜伤官泄秀 / 喜财星";
                    } else {
                        patternResult = "伤官佩印格";
                        godResult = isStrong ? "喜财泄伤 / 喜印护身" : "喜印制伤 / 忌财";
                    }
                }
            }
            // 财星格
            else if (monthShiShen === '财星') {
                if (monthDetailShiShen === '正财') {
                    if (isStrong) {
                        patternResult = "正财格 (正财透干)";
                        if (shiShenCount['官杀'] >= 2) {
                            patternResult = "财官双美格";
                            godResult = "喜财滋官 / 喜食伤生财";
                        } else {
                            godResult = "喜食伤生财 / 忌比劫夺财";
                        }
                    } else {
                        patternResult = "财多身弱格";
                        godResult = "喜印比帮身 / 忌财官再来";
                    }
                } else {
                    // 偏财格
                    if (isStrong) {
                        patternResult = "偏财格 (横财之命)";
                        godResult = "喜食伤生财 / 喜身旺 / 忌比劫";
                    } else {
                        patternResult = "财多身弱格";
                        godResult = "喜比劫分财 / 喜印星化财";
                    }
                }
            }
            // 官杀格
            else if (monthShiShen === '官杀') {
                if (monthDetailShiShen === '正官') {
                    if (isStrong) {
                        patternResult = "正官格 (正官佩印)";
                        if (shiShenCount['印星'] >= 2) {
                            patternResult = "官印相生格";
                            godResult = "喜官印相生 / 喜财滋官";
                        } else if (shiShenCount['财星'] >= 2) {
                            patternResult = "财官双美格";
                            godResult = "喜财生官 / 忌伤官";
                        } else {
                            godResult = "喜印护官 / 喜财生官 / 忌伤官";
                        }
                    } else {
                        patternResult = "官多身弱格";
                        godResult = "喜印化官 / 喜比劫帮身 / 忌财";
                    }
                } else {
                    // 七杀格
                    if (detailShiShenCount['食神'] >= 1) {
                        patternResult = "杀邀食制格 (七杀配食神)";
                        godResult = "喜食神制杀 / 忌印夺食";
                    } else if (shiShenCount['印星'] >= 2) {
                        patternResult = "杀印相生格";
                        godResult = "喜杀印相生 / 喜身旺";
                    } else if (isStrong) {
                        patternResult = "七杀格 (偏官有制)";
                        godResult = "喜食伤制杀 / 喜印化杀";
                    } else {
                        patternResult = "杀重身轻格";
                        godResult = "喜印化杀 / 喜食神制杀 / 急需帮身";
                    }
                }
            }
            // 印星格
            else if (monthShiShen === '印星') {
                if (monthDetailShiShen === '正印') {
                    if (isStrong) {
                        patternResult = "正印格 (印绶护身)";
                        if (shiShenCount['官杀'] >= 2) {
                            patternResult = "官印相生格";
                            godResult = "喜官生印 / 喜印护身";
                        } else {
                            godResult = "喜官生印 / 喜财制印 / 忌比劫";
                        }
                    } else {
                        patternResult = "印绶护身格";
                        godResult = "喜官生印 / 喜印比帮身";
                    }
                } else {
                    // 偏印格
                    if (detailShiShenCount['食神'] >= 1) {
                        patternResult = "枭神夺食格 (偏印夺食)";
                        godResult = "喜财制枭 / 喜比劫化枭";
                    } else {
                        patternResult = "偏印格 (倒食格)";
                        godResult = isStrong ? "喜财制印 / 喜食伤泄秀" : "喜官杀生印 / 喜比劫";
                    }
                }
            }
            // 默认格局
            else {
                if (isStrong) {
                    patternResult = "身旺无依格";
                    godResult = "喜食伤泄秀 / 喜财星耗身 / 喜官杀制身";
                } else if (isWeak) {
                    patternResult = "身弱无根格";
                    godResult = "喜印星生身 / 喜比劫帮身 / 忌财官食伤";
                } else {
                    patternResult = "中和格 (平衡之命)";
                    godResult = "五行平衡 / 顺势而为 / 忌过旺过衰";
                }
            }
        }
        
        // 添加八字信息
        const baziInfo = `${yearGan}${yearZhi}年 ${monthGan}${monthZhi}月 ${dayGan}${dayZhi}日 ${hourGan}${hourZhi}时`;
        
        // 计算纳音
        const yearNaYin = getNaYin(yearGan, yearZhi);
        const monthNaYin = getNaYin(monthGan, monthZhi);
        const dayNaYin = getNaYin(dayGan, dayZhi);
        const hourNaYin = getNaYin(hourGan, hourZhi);
        
        // 计算大运
        const daYun = calculateDaYun(yearGan, yearZhi, monthGan, monthZhi, 'male', year);
        
        // 计算流年
        const liuNian = calculateLiuNian(year, new Date().getFullYear());
        
        // 判断身强身弱身平
        let strengthText = '中和';
        if (isStrong) strengthText = '身强';
        else if (isWeak) strengthText = '身弱';
        
        return { 
            pattern: patternResult, 
            god: godResult,
            bazi: baziInfo,
            dayGan: dayGan,
            strength: strengthText,
            // 详细八字信息
            year: { gan: yearGan, zhi: yearZhi, ganzhi: yearGan + yearZhi, nayin: yearNaYin },
            month: { gan: monthGan, zhi: monthZhi, ganzhi: monthGan + monthZhi, nayin: monthNaYin },
            day: { gan: dayGan, zhi: dayZhi, ganzhi: dayGan + dayZhi, nayin: dayNaYin },
            hour: { gan: hourGan, zhi: hourZhi, ganzhi: hourGan + hourZhi, nayin: hourNaYin },
            wuXingCount: wuXingCount,
            daYun: daYun,
            liuNian: liuNian,
            birthYear: year
        };
    }

    // 模拟数据生成器 - 增加 dob 参数
    function generateData(startYear, dob) {
        const data = []; // [Date, Open, Close, Low, High, Vol]
        const events = [];
        let score = 60;
        
        // --- 【精确的格局与喜用神判断】 ---
        const birthHour = document.getElementById('birth-hour').value;
        const analysis = analyzePattern(dob, birthHour);
        
        // 保存完整分析结果到全局变量
        currentBaziAnalysis = analysis;
        
        let patternResult = analysis.pattern;
        let godResult = analysis.god;
        let baziInfo = analysis.bazi;
        let strengthInfo = analysis.strength;
        // --- 【格局与喜用神判断结束】 ---

        const dateObj = new Date(dob);
        const monthNames = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
        
        // 根据粒度生成不同的数据
        if (currentGranularity === 'day') {
            // 日K线 - 生成当前年份的365天
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const daysInYear = 365;
            
            for (let dayIndex = 0; dayIndex < daysInYear; dayIndex++) {
                const date = new Date(currentYear, 0, 1);
                date.setDate(date.getDate() + dayIndex);
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                const dayTrend = Math.sin(dayIndex / 30) * 8 + Math.cos(dayIndex / 7) * 5;
                
                let open = score;
                let change = (Math.random() * 10 - 5) + (dayTrend * 0.2);
                let close = open + change;
                
                close = Math.max(20, Math.min(95, close));
                
                let low = Math.min(open, close) - Math.random() * 3;
                let high = Math.max(open, close) + Math.random() * 3;
                
                low = Math.max(10, low);
                high = Math.min(99, high);
                
                let vol = Math.floor(Math.random() * 500) + 300;
                
                // 每日事件
                let eventType = "平稳";
                const changePercent = ((close - open) / open) * 100;
                
                if (changePercent > 5) {
                    const goodEvents = ["心情愉悦", "小有收获", "好运连连", "事事顺心"];
                    eventType = goodEvents[Math.floor(Math.random() * goodEvents.length)];
                } else if (changePercent < -5) {
                    const badEvents = ["小有波折", "需要休息", "保持低调", "调整心态"];
                    eventType = badEvents[Math.floor(Math.random() * badEvents.length)];
                } else {
                    const neutralEvents = ["平稳", "如常", "顺其自然"];
                    eventType = neutralEvents[Math.floor(Math.random() * neutralEvents.length)];
                }
                
                // 特殊日期标记
                if (date.getMonth() === 0 && date.getDate() === 1) eventType = "🎊 元旦";
                else if (date.getMonth() === 1 && date.getDate() === 14) eventType = "💝 情人节";
                else if (date.getMonth() === 4 && date.getDate() === 1) eventType = "🎉 劳动节";
                else if (date.getMonth() === 9 && date.getDate() === 1) eventType = "🎃 国庆节";
                else if (date.getMonth() === 11 && date.getDate() === 25) eventType = "🎄 圣诞节";
                
                data.push([
                    dateStr,
                    open.toFixed(1),
                    close.toFixed(1),
                    low.toFixed(1),
                    high.toFixed(1),
                    vol,
                    eventType,
                    dayIndex
                ]);
                
                events.push({ year: dateStr, age: dayIndex, close: close.toFixed(1), type: eventType, isUp: close >= open });
                score = close;
            }
            
        } else if (currentGranularity === 'month') {
            // 月K线 - 生成当前10年的120个月
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const startYearForMonth = currentYear - 5; // 前5年到后5年
            
            for (let yearOffset = 0; yearOffset < 10; yearOffset++) {
                for (let month = 0; month < 12; month++) {
                    const displayYear = startYearForMonth + yearOffset;
                    const dateStr = `${displayYear}-${monthNames[month]}`;
                    const totalMonths = yearOffset * 12 + month;
                    
                    const monthTrend = Math.sin(totalMonths / 12) * 10;
                    
                    let open = score;
                    let change = (Math.random() * 12 - 6) + (monthTrend * 0.25);
                    let close = open + change;
                    
                    close = Math.max(20, Math.min(95, close));
                    
                    let low = Math.min(open, close) - Math.random() * 4;
                    let high = Math.max(open, close) + Math.random() * 4;
                    
                    low = Math.max(10, low);
                    high = Math.min(99, high);
                    
                    let vol = Math.floor(Math.random() * 800) + 400;
                    
                    // 每月事件
                    let eventType = "平稳";
                    const changePercent = ((close - open) / open) * 100;
                    
                    if (changePercent > 6) {
                        const goodEvents = ["月度进步", "收获颇丰", "运势上扬", "诸事顺利"];
                        eventType = goodEvents[Math.floor(Math.random() * goodEvents.length)];
                    } else if (changePercent < -6) {
                        const badEvents = ["略有起伏", "需要调整", "稳中求进", "静待转机"];
                        eventType = badEvents[Math.floor(Math.random() * badEvents.length)];
                    } else {
                        const neutralEvents = ["平稳", "稳定发展", "按部就班"];
                        eventType = neutralEvents[Math.floor(Math.random() * neutralEvents.length)];
                    }
                    
                    data.push([
                        dateStr,
                        open.toFixed(1),
                        close.toFixed(1),
                        low.toFixed(1),
                        high.toFixed(1),
                        vol,
                        eventType,
                        totalMonths
                    ]);
                    
                    events.push({ year: dateStr, age: totalMonths, close: close.toFixed(1), type: eventType, isUp: close >= open });
                    score = close;
                }
            }
            
        } else {
            // 年K线 - 原有的80年数据
        for (let age = 0; age <= 80; age++) {
            const year = startYear + age;
            const trend = Math.sin(age / 7) * 12;
            
            let open = score;
            let change = (Math.random() * 16 - 8) + (trend * 0.3);
            let close = open + change;
            
            close = Math.max(20, Math.min(95, close));
            
            let low = Math.min(open, close) - Math.random() * 5;
            let high = Math.max(open, close) + Math.random() * 5;
            
            low = Math.max(10, low);
            high = Math.min(99, high);

            let vol = Math.floor(Math.random() * 1000) + 500;
            if(age > 20 && age < 50) vol += 500; 

            // 更丰富的事件类型判定
            let eventType = "平稳";
            const changePercent = ((close - open) / open) * 100;
            
            if (changePercent > 8) {
                const goodEvents = ["财星高照", "大吉大利", "贵人相助", "事业高升", "桃花运旺"];
                eventType = goodEvents[Math.floor(Math.random() * goodEvents.length)];
            } else if (changePercent > 3) {
                const normalGoodEvents = ["小有收获", "稳步上升", "运势渐好", "心想事成"];
                eventType = normalGoodEvents[Math.floor(Math.random() * normalGoodEvents.length)];
            } else if (changePercent < -8) {
                const badEvents = ["七杀克身", "破财之灾", "小人作祟", "事业受阻", "健康预警"];
                eventType = badEvents[Math.floor(Math.random() * badEvents.length)];
            } else if (changePercent < -3) {
                const normalBadEvents = ["略有波折", "需要谨慎", "低调为宜", "蓄势待发"];
                eventType = normalBadEvents[Math.floor(Math.random() * normalBadEvents.length)];
            } else {
                const neutralEvents = ["平稳", "中规中矩", "顺其自然", "静候佳音"];
                eventType = neutralEvents[Math.floor(Math.random() * neutralEvents.length)];
            }
            
            // 特殊年龄段的事件
            if (age === 18) eventType = "🎓 成人礼";
            else if (age === 22) eventType = "🎓 大学毕业";
            else if (age >= 25 && age <= 35 && Math.random() > 0.8) eventType = "💼 职场晋升";
            else if (age >= 28 && age <= 32 && Math.random() > 0.85) eventType = "💑 良缘";
            else if (age === 30) eventType = "🎂 而立之年";
            else if (age === 40) eventType = "💪 不惑之年";
            else if (age === 50) eventType = "🌟 知天命";
            else if (age === 60) eventType = "🎊 花甲之年";

            data.push([
                `${year}`,   
                open.toFixed(1),  
                close.toFixed(1), 
                low.toFixed(1),   
                high.toFixed(1),  
                vol,              
                eventType,        
                age               
            ]);

            events.push({ year, age, close: close.toFixed(1), type: eventType, isUp: close >= open });
            
            score = close;
        }
        }
        
        // 返回包含格局信息的对象
        return { 
            rawData: data, 
            events: events, 
            pattern: patternResult, 
            god: godResult,
            bazi: baziInfo,
            strength: strengthInfo
        };
    }

    function initChart(dataset) {
        currentDataset = dataset;
        const dom = document.getElementById('kline-chart');
        if(chartInstance) chartInstance.dispose();
        chartInstance = echarts.init(dom);

        const rawData = dataset.rawData;
        const dates = rawData.map(item => item[0]);
        const data = rawData.map(item => [+item[1], +item[2], +item[3], +item[4]]); // O, C, L, H
        const volumes = rawData.map((item, index) => [index, item[5], item[1] > item[2] ? -1 : 1]); 

        // 更新顶部 Header 数据
        const allHigh = Math.max(...rawData.map(i => parseFloat(i[4])));
        const allLow = Math.min(...rawData.map(i => parseFloat(i[3])));
        const currentClose = parseFloat(rawData[rawData.length - 1][2]);
        const firstOpen = parseFloat(rawData[0][1]);
        const totalChange = ((currentClose - firstOpen) / firstOpen * 100).toFixed(2);
        
        document.getElementById('current-score').innerText = currentClose.toFixed(2);
        document.getElementById('current-score').style.color = currentClose >= firstOpen ? colors.up : colors.down;
        document.getElementById('high-score').innerText = allHigh.toFixed(2);
        document.getElementById('low-score').innerText = allLow.toFixed(2);
        
        // 计算平均能量
        const avgVol = Math.floor(volumes.reduce((sum, v) => sum + v[1], 0) / volumes.length);
        document.getElementById('vol-score').innerText = avgVol.toLocaleString();
        
        // 更新24小时统计
        update24hStats(dataset);

        // 根据当前激活的指标构建 legend 数据
        const legendData = ['K线'];
        if (activeIndicators.ma) {
            legendData.push('MA7', 'MA25', 'MA99');
        }
        if (activeIndicators.ema) {
            legendData.push('EMA7', 'EMA25', 'EMA99');
        }
        if (activeIndicators.boll) {
            legendData.push('BOLL-MID', 'BOLL-UPPER', 'BOLL-LOWER');
        }

        const option = {
            backgroundColor: colors.bg,
            animation: true,
            legend: {
                data: legendData,
                top: 10,
                left: 20,
                textStyle: { color: colors.text, fontSize: 10 },
                inactiveColor: '#444'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross', lineStyle: { type: 'dashed', color: '#666' } },
                backgroundColor: 'rgba(22, 26, 30, 0.9)',
                borderColor: colors.border,
                textStyle: { color: colors.text, fontSize: 11 },
                formatter: function (params) {
                    let res = '';
                    let kParam = params.find(p => p.seriesName === 'K线');
                    if(kParam) {
                        const dataIdx = kParam.dataIndex;
                        const item = rawData[dataIdx];
                        const color = item[2] >= item[1] ? colors.up : colors.down;
                        const change = ((item[2] - item[1])/item[1] * 100).toFixed(2);
                        
                        document.getElementById('current-score').innerText = item[2];
                        document.getElementById('current-score').style.color = color;

                        res += `<div style="color:${colors.text}">时间: <b style="color:white">${item[0]} (${item[7]}岁)</b></div>`;
                        res += `<div style="display:flex; justify-content:space-between; gap:15px; margin-top:5px;">
                                <span>开: <b style="color:${color}">${item[1]}</b></span>
                                <span>高: <b style="color:${color}">${item[4]}</b></span>
                                </div>`;
                        res += `<div style="display:flex; justify-content:space-between; gap:15px;">
                                <span>低: <b style="color:${color}">${item[3]}</b></span>
                                <span>收: <b style="color:${color}">${item[2]}</b></span>
                                </div>`;
                        res += `<div style="margin-top:5px; border-top:1px solid #333; padding-top:5px;">
                                涨跌幅: <span style="color:${color}">${change}%</span><br>
                                评语: <span style="color:#fff">${item[6]}</span>
                                </div>`;
                    }
                    return res;
                }
            },
            axisPointer: { link: { xAxisIndex: 'all' } },
            grid: [
                { left: '20px', right: '50px', top: '40px', height: '60%' }, 
                { left: '20px', right: '50px', top: '75%', height: '15%' }  
            ],
            xAxis: [
                {
                    type: 'category',
                    data: dates,
                    axisLine: { lineStyle: { color: colors.grid } },
                    axisLabel: { show: false }, 
                    axisTick: { show: false }
                },
                {
                    type: 'category',
                    gridIndex: 1,
                    data: dates,
                    axisLine: { lineStyle: { color: colors.grid } },
                    axisLabel: { color: colors.text, fontSize: 10 },
                    axisTick: { show: false }
                }
            ],
            yAxis: [
                {
                    scale: true,
                    position: 'right', 
                    axisLine: { show: false },
                    splitLine: { show: true, lineStyle: { color: colors.grid, width: 0.5 } },
                    axisLabel: { color: colors.text, fontSize: 10, formatter: '{value}' }
                },
                {
                    scale: true,
                    gridIndex: 1,
                    position: 'right',
                    splitNumber: 2,
                    axisLabel: { show: false },
                    axisLine: { show: false },
                    splitLine: { show: false }
                }
            ],
            dataZoom: [
                { type: 'inside', xAxisIndex: [0, 1], start: currentPeriod === '1y' ? 70 : 20, end: currentPeriod === '1y' ? 100 : 60 },
                { type: 'slider', xAxisIndex: [0, 1], bottom: 5, height: 15, borderColor: colors.grid, fillerColor: 'rgba(255,255,255,0.1)', handleStyle: {color: colors.text}, textStyle: {color: colors.text} }
            ],
            series: [
                {
                    name: 'K线',
                    type: 'candlestick',
                    data: data,
                    itemStyle: {
                        color: colors.up,        
                        color0: colors.down,     
                        borderColor: colors.up,  
                        borderColor0: colors.down 
                    }
                }
            ]
        };

        // 添加 MA 指标
        if (activeIndicators.ma) {
            option.series.push(
                {
                    name: 'MA7',
                    type: 'line',
                    data: calculateMA(7, data),
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { width: 1, color: colors.ma7 }
                },
                {
                    name: 'MA25',
                    type: 'line',
                    data: calculateMA(25, data),
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { width: 1, color: colors.ma25 }
                },
                {
                    name: 'MA99',
                    type: 'line',
                    data: calculateMA(99, data),
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { width: 1, color: colors.ma99 }
                }
            );
        }

        // 添加 EMA 指标
        if (activeIndicators.ema) {
            option.series.push(
                {
                    name: 'EMA7',
                    type: 'line',
                    data: calculateEMA(7, data),
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { width: 1.5, color: '#ffaa00', type: 'dashed' }
                },
                {
                    name: 'EMA25',
                    type: 'line',
                    data: calculateEMA(25, data),
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { width: 1.5, color: '#ff6b9d', type: 'dashed' }
                },
                {
                    name: 'EMA99',
                    type: 'line',
                    data: calculateEMA(99, data),
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { width: 1.5, color: '#00d4ff', type: 'dashed' }
                }
            );
        }

        // 添加 BOLL 指标
        if (activeIndicators.boll) {
            const boll = calculateBOLL(20, data);
            option.series.push(
                {
                    name: 'BOLL-MID',
                    type: 'line',
                    data: boll.ma,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { width: 1, color: '#7cb342' }
                },
                {
                    name: 'BOLL-UPPER',
                    type: 'line',
                    data: boll.upper,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { width: 1, color: '#7cb342', opacity: 0.5 }
                },
                {
                    name: 'BOLL-LOWER',
                    type: 'line',
                    data: boll.lower,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { width: 1, color: '#7cb342', opacity: 0.5 }
                }
            );
        }

        // 添加成交量
        option.series.push({
                    name: '能量',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: volumes,
                    itemStyle: {
                        color: function(params) {
                            const kData = data[params.dataIndex];
                            return kData[1] > kData[0] ? colors.up : colors.down;
                        }
                    }
        });
        chartInstance.setOption(option);
        
        window.addEventListener('resize', () => chartInstance.resize());
    }

    // ============ 交易所功能函数 ============
    
    // 切换交易面板标签
    function switchTradeTab(tab) {
        currentTradeTab = tab;
        
        // 更新标签样式
        ['orderbook', 'trades', 'position', 'assets'].forEach(t => {
            const tabEl = document.getElementById(`tab-${t}`);
            const panelEl = document.getElementById(`panel-${t}`);
            
            if (t === tab) {
                tabEl.classList.remove('text-[#848e9c]', 'border-transparent');
                tabEl.classList.add('text-white', 'border-[#f0b90b]', 'border-b-2');
                panelEl.classList.remove('hidden');
                panelEl.classList.add('flex');
            } else {
                tabEl.classList.remove('text-white', 'border-[#f0b90b]', 'border-b-2');
                tabEl.classList.add('text-[#848e9c]');
                panelEl.classList.remove('flex');
                panelEl.classList.add('hidden');
            }
        });
        
        // 如果切换到成交面板，生成成交记录
        if (tab === 'trades') {
            generateRecentTrades();
        }
    }
    
    // 生成行情滚动数据
    function initTickerTape() {
        tickerData = [
            { symbol: 'LIFE/TIME', price: 60.00, change: '+2.35%', isUp: true },
            { symbol: '健康/HEALTH', price: 85.50, change: '+1.28%', isUp: true },
            { symbol: '财富/WEALTH', price: 45.20, change: '-0.85%', isUp: false },
            { symbol: '事业/CAREER', price: 72.80, change: '+3.42%', isUp: true },
            { symbol: '爱情/LOVE', price: 68.90, change: '-1.15%', isUp: false },
            { symbol: '家庭/FAMILY', price: 78.30, change: '+0.95%', isUp: true },
            { symbol: '学业/STUDY', price: 55.60, change: '+2.18%', isUp: true },
            { symbol: '人气/POPULAR', price: 63.40, change: '-0.42%', isUp: false }
        ];
        
        updateTickerTape();
    }
    
    // 更新行情滚动条
    function updateTickerTape() {
        const container = document.getElementById('ticker-content');
        let html = '';
        
        // 生成两份相同的内容以实现无缝循环
        for (let i = 0; i < 2; i++) {
            tickerData.forEach(item => {
                const colorClass = item.isUp ? 'text-[#0ecb81]' : 'text-[#f6465d]';
                html += `
                    <div class="ticker-item">
                        <span class="text-white font-medium">${item.symbol}</span>
                        <span class="${colorClass} font-mono">${item.price.toFixed(2)}</span>
                        <span class="${colorClass} text-[10px]">${item.change}</span>
                    </div>
                `;
            });
        }
        
        container.innerHTML = html;
    }
    
    // 生成最近成交记录
    function generateRecentTrades() {
        if (!currentDataset) return;
        
        const container = document.getElementById('recent-trades');
        recentTrades = [];
        
        // 生成20条随机成交记录
        for (let i = 0; i < 20; i++) {
            const now = new Date();
            const time = new Date(now.getTime() - i * 3000);
            const price = (Math.random() * 20 + 50).toFixed(2);
            const amount = (Math.random() * 10 + 1).toFixed(2);
            const isUp = Math.random() > 0.5;
            
            recentTrades.push({
                time: time.toTimeString().substr(0, 8),
                price: price,
                amount: amount,
                isUp: isUp
            });
        }
        
        // 渲染成交记录
        container.innerHTML = recentTrades.map(trade => {
            const colorClass = trade.isUp ? 'text-[#0ecb81]' : 'text-[#f6465d]';
            return `
                <div class="flex justify-between text-xs px-2 py-1 hover:bg-[#2b3139]">
                    <span class="text-[#848e9c] font-mono">${trade.time}</span>
                    <span class="${colorClass} font-mono">${trade.price}</span>
                    <span class="text-white font-mono">${trade.amount}</span>
                </div>
            `;
        }).join('');
    }
    
    // 更新24小时统计
    function update24hStats(dataset) {
        if (!dataset || !dataset.rawData || dataset.rawData.length === 0) return;
        
        const data = dataset.rawData;
        const firstPrice = parseFloat(data[0][1]);
        const lastPrice = parseFloat(data[data.length - 1][2]);
        const change = ((lastPrice - firstPrice) / firstPrice * 100).toFixed(2);
        const isUp = change >= 0;
        
        // 更新涨跌幅
        const changeEl = document.getElementById('price-change');
        if (changeEl) {
            changeEl.innerText = (isUp ? '+' : '') + change + '%';
            changeEl.style.color = isUp ? colors.up : colors.down;
        }
        
        // 更新成交额
        const turnoverEl = document.getElementById('turnover');
        if (turnoverEl) {
            const totalVol = data.reduce((sum, item) => sum + (item[5] || 0), 0);
            turnoverEl.innerText = (totalVol / 1000).toFixed(2) + 'K';
        }
    }

    function updateOrderBookHeader() {
        const header = document.getElementById('order-book-header');
        let timeLabel = '年份/年龄';
        
        if (currentGranularity === 'day') {
            timeLabel = '日期';
        } else if (currentGranularity === 'month') {
            timeLabel = '月份';
        } else {
            timeLabel = '年份/年龄';
        }
        
        header.innerHTML = `
            <span>${timeLabel}</span>
            <span>运势(Price)</span>
            <span>事件(Event)</span>
        `;
    }

    function renderOrderBook(events) {
        updateOrderBookHeader();
        
        const container = document.getElementById('order-book');
        container.innerHTML = '';
        
        // 计算深度（用于可视化）
        const maxPrice = Math.max(...events.map(e => parseFloat(e.close)));
        const minPrice = Math.min(...events.map(e => parseFloat(e.close)));
        
        events.slice().reverse().forEach((evt, idx) => {
            const el = document.createElement('div');
            el.className = 'order-book-item px-4 fade-in-up';
            el.style.animationDelay = `${idx * 0.01}s`;
            el.style.position = 'relative';
            const colorClass = evt.isUp ? 'text-[#0ecb81]' : 'text-[#f6465d]';
            
            // 根据粒度显示不同的时间标签
            let timeLabel = '';
            let titleText = '';
            if (currentGranularity === 'day') {
                timeLabel = evt.year;
                titleText = `点击查看 ${evt.year} 详情`;
            } else if (currentGranularity === 'month') {
                timeLabel = evt.year;
                titleText = `点击查看 ${evt.year} 详情`;
            } else {
                timeLabel = `${evt.year} <span class="scale-75 inline-block opacity-50">(${evt.age}岁)</span>`;
                titleText = `点击查看 ${evt.year} 年 (${evt.age}岁) 详情`;
            }
            
            // 计算深度条宽度（归一化到0-100%）
            const priceRange = maxPrice - minPrice;
            const depthPercent = priceRange > 0 ? ((parseFloat(evt.close) - minPrice) / priceRange * 50) : 25;
            const depthClass = evt.isUp ? 'buy' : 'sell';
            
            el.innerHTML = `
                <div class="depth-bar ${depthClass}" style="width: ${depthPercent}%;"></div>
                <span class="text-[#848e9c] w-1/3 text-left relative z-10">${timeLabel}</span>
                <span class="${colorClass} w-1/3 text-right font-mono relative z-10">${evt.close}</span>
                <span class="text-white w-1/3 text-right text-[11px] relative z-10">${evt.type}</span>
            `;
            el.title = titleText;
            el.onclick = () => { 
                jumpToYear(evt.age);
            };
            container.appendChild(el);
        });
    }

    // 跳转到指定年龄
    function jumpToYear(age) {
        if (!chartInstance || !currentDataset) return;
        
        const totalYears = currentDataset.rawData.length;
        const targetIndex = age;
        
        // 计算显示范围（前后各5-10年，取决于周期）
        const rangeSize = currentPeriod === '1y' ? 5 : 15;
        let start = Math.max(0, targetIndex - rangeSize);
        let end = Math.min(totalYears, targetIndex + rangeSize);
        
        chartInstance.dispatchAction({
            type: 'dataZoom',
            startValue: start,
            endValue: end
        });

        // 延迟显示tooltip，确保缩放完成
        setTimeout(() => {
            chartInstance.dispatchAction({
                type: 'showTip',
                seriesIndex: 0,
                dataIndex: targetIndex
            });
        }, 300);
        
        // 高亮订单簿中的项
        highlightOrderBookItem(age);
    }

    // 高亮订单簿项目
    function highlightOrderBookItem(age) {
        document.querySelectorAll('.order-book-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // 查找并高亮对应项
        const items = document.querySelectorAll('.order-book-item');
        const events = currentDataset.events.slice().reverse();
        events.forEach((evt, idx) => {
            if (evt.age === age && items[idx]) {
                items[idx].classList.add('active');
                items[idx].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    }

    function runSimulation() {
        const loader = document.getElementById('chart-loader');
        const loadingTips = [
            '📊 正在分析八字命盘...',
            '🔮 计算五行强弱中...',
            '✨ 推演大运流年...',
            '🌟 生成人生轨迹...',
            '💫 连接命运服务器...',
            '🎯 预测未来走势...',
            '⚡ 加载运势数据...',
            '🎨 绘制命运曲线...'
        ];
        
        const randomTip = loadingTips[Math.floor(Math.random() * loadingTips.length)];
        document.getElementById('loading-tips').innerText = randomTip;
        
        loader.classList.remove('hidden');
        
        setTimeout(() => {
            const dob = document.getElementById('dob').value;
            const year = parseInt(dob.split('-')[0]);
            
            // 将 dob 传递给生成函数
            const dataset = generateData(year, dob); 
            
            initChart(dataset);
            renderOrderBook(dataset.events);
            
            loader.classList.add('hidden');

            // --- 【刷新 UI 关键代码】 ---
            if (currentTab === 'bazi') {
                document.getElementById('bazi-result').innerText = dataset.bazi || '未排盘';
                document.getElementById('strength-result').innerText = dataset.strength || '-';
            document.getElementById('pattern-result').innerText = dataset.pattern;
            document.getElementById('god-result').innerText = dataset.god;
                
                // 根据身强身弱设置颜色
                if (dataset.strength === '身强') {
                    document.getElementById('strength-result').style.color = colors.up;
                } else if (dataset.strength === '身弱') {
                    document.getElementById('strength-result').style.color = colors.down;
                }
            }
            // --- 【刷新 UI 关键代码】 ---

        }, 1000); 
    }

    // 切换时间粒度
    function switchGranularity(granularity) {
        currentGranularity = granularity;
        
        // 更新按钮样式
        document.getElementById('granularity-day').classList.remove('text-[#f0b90b]');
        document.getElementById('granularity-month').classList.remove('text-[#f0b90b]');
        document.getElementById('granularity-year').classList.remove('text-[#f0b90b]');
        document.getElementById(`granularity-${granularity}`).classList.add('text-[#f0b90b]');
        
        // 重新生成数据
        runSimulation();
    }

    // 切换时间周期
    function switchPeriod(period) {
        currentPeriod = period;
        
        // 更新按钮样式
        document.getElementById('period-1y').classList.remove('text-[#f0b90b]');
        document.getElementById('period-10y').classList.remove('text-[#f0b90b]');
        document.getElementById(`period-${period}`).classList.add('text-[#f0b90b]');
        
        // 重新渲染图表
        if (currentDataset) {
            initChart(currentDataset);
        }
    }

    // 切换指标
    function toggleIndicator(indicator) {
        activeIndicators[indicator] = !activeIndicators[indicator];
        
        // 更新按钮样式
        const indicatorBtn = document.getElementById(`indicator-${indicator}`);
        if (activeIndicators[indicator]) {
            indicatorBtn.classList.remove('text-[#848e9c]');
            indicatorBtn.classList.add(indicator === 'ma' ? 'text-[#f0b90b]' : indicator === 'ema' ? 'text-[#d897cd]' : 'text-[#6885ce]');
        } else {
            indicatorBtn.classList.add('text-[#848e9c]');
            indicatorBtn.classList.remove('text-[#f0b90b]', 'text-[#d897cd]', 'text-[#6885ce]');
        }
        
        // 重新渲染图表
        if (currentDataset) {
            initChart(currentDataset);
        }
    }

    // 切换排盘类型
    function switchTab(tab) {
        currentTab = tab;
        
        // 更新按钮样式
        document.getElementById('tab-bazi').classList.remove('bg-[#2b3139]', 'text-white');
        document.getElementById('tab-ziwei').classList.remove('bg-[#2b3139]', 'text-white');
        document.getElementById('tab-bazi').classList.add('text-[#848e9c]');
        document.getElementById('tab-ziwei').classList.add('text-[#848e9c]');
        
        document.getElementById(`tab-${tab}`).classList.remove('text-[#848e9c]');
        document.getElementById(`tab-${tab}`).classList.add('bg-[#2b3139]', 'text-white');
        
        // 根据不同类型显示不同的排盘结果
        const baziEl = document.getElementById('bazi-result');
        const strengthEl = document.getElementById('strength-result');
        const patternEl = document.getElementById('pattern-result');
        const godEl = document.getElementById('god-result');
        
        if (tab === 'ziwei') {
            baziEl.innerText = '紫微斗数命盘';
            strengthEl.innerText = '庙旺';
            strengthEl.style.color = colors.up;
            patternEl.innerText = '紫微在午 (帝王坐命)';
            godEl.innerText = '天府星系 / 化权';
        } else if (currentDataset) {
            baziEl.innerText = currentDataset.bazi || '未排盘';
            strengthEl.innerText = currentDataset.strength || '-';
            if (currentDataset.strength === '身强') {
                strengthEl.style.color = colors.up;
            } else if (currentDataset.strength === '身弱') {
                strengthEl.style.color = colors.down;
            }
            patternEl.innerText = currentDataset.pattern;
            godEl.innerText = currentDataset.god;
        }
    }

    // 显示详细八字信息
    function showBaziDetail() {
        if (!currentBaziAnalysis) {
            showCustomAlert('请先生成人生K线！', 'info');
            return;
        }
        
        const bz = currentBaziAnalysis;
        
        // 五行统计
        let wuXingHTML = '';
        for (let wx in bz.wuXingCount) {
            const count = bz.wuXingCount[wx];
            const wuXingColor = {
                '木': '#0ecb81', '火': '#f6465d', '土': '#f0b90b', 
                '金': '#d4d4d4', '水': '#3b82f6'
            };
            wuXingHTML += `<span style="color: ${wuXingColor[wx]}; margin-right: 12px;">${wx}: ${count}</span>`;
        }
        
        // 大运列表
        let dayunHTML = '';
        bz.daYun.forEach((dy, idx) => {
            const isCurrent = dy.age <= (new Date().getFullYear() - bz.birthYear) && 
                             (new Date().getFullYear() - bz.birthYear) < dy.age + 10;
            const highlight = isCurrent ? 'background: rgba(240, 185, 11, 0.2); border-left: 3px solid #f0b90b;' : '';
            dayunHTML += `
                <div style="padding: 8px 12px; border-bottom: 1px solid #2b3139; ${highlight}">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #eaecef; font-weight: bold;">${dy.ganzhi}</span>
                        <span style="color: #848e9c; font-size: 11px;">${dy.range}</span>
                    </div>
                    <div style="color: #848e9c; font-size: 11px; margin-top: 4px;">${dy.nayin}</div>
                </div>
            `;
        });
        
        // 流年列表
        let liunianHTML = '';
        bz.liuNian.forEach((ln, idx) => {
            const isCurrent = ln.year === new Date().getFullYear();
            const highlight = isCurrent ? 'background: rgba(240, 185, 11, 0.2); border-left: 3px solid #f0b90b;' : '';
            liunianHTML += `
                <div style="padding: 6px 12px; border-bottom: 1px solid #2b3139; ${highlight}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #eaecef;">${ln.year}年 <span style="color: #f0b90b;">${ln.ganzhi}</span></span>
                        <span style="color: #848e9c; font-size: 10px;">${ln.age}岁 · ${ln.nayin}</span>
                    </div>
                </div>
            `;
        });
        
        const overlay = document.createElement('div');
        overlay.className = 'custom-alert-overlay';
        overlay.onclick = closeCustomAlert;
        
        const detailPanel = document.createElement('div');
        detailPanel.className = 'help-panel';
        detailPanel.style.maxWidth = '800px';
        detailPanel.style.maxHeight = '85vh';
        
        detailPanel.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #2b3139; padding-bottom: 15px;">
                <h2 style="color: #f0b90b; font-size: 20px; font-weight: bold;">🔮 八字详批</h2>
                <button onclick="closeCustomAlert()" style="background: none; border: none; color: #848e9c; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                <!-- 左侧：四柱八字 -->
                <div>
                    <h3 style="color: #f0b90b; font-size: 16px; margin-bottom: 15px;">📅 四柱八字</h3>
                    <div style="background: #1e2329; padding: 15px; border-radius: 8px;">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center;">
                            <div>
                                <div style="color: #848e9c; font-size: 11px; margin-bottom: 5px;">年柱</div>
                                <div style="color: #f0b90b; font-size: 16px; font-weight: bold; margin-bottom: 3px;">${bz.year.ganzhi}</div>
                                <div style="color: #0ecb81; font-size: 10px;">${bz.year.nayin}</div>
                            </div>
                            <div>
                                <div style="color: #848e9c; font-size: 11px; margin-bottom: 5px;">月柱</div>
                                <div style="color: #f0b90b; font-size: 16px; font-weight: bold; margin-bottom: 3px;">${bz.month.ganzhi}</div>
                                <div style="color: #0ecb81; font-size: 10px;">${bz.month.nayin}</div>
                            </div>
                            <div style="background: rgba(240, 185, 11, 0.1); border-radius: 4px;">
                                <div style="color: #848e9c; font-size: 11px; margin-bottom: 5px;">日柱 ⭐</div>
                                <div style="color: #f0b90b; font-size: 16px; font-weight: bold; margin-bottom: 3px;">${bz.day.ganzhi}</div>
                                <div style="color: #0ecb81; font-size: 10px;">${bz.day.nayin}</div>
                            </div>
                            <div>
                                <div style="color: #848e9c; font-size: 11px; margin-bottom: 5px;">时柱</div>
                                <div style="color: #f0b90b; font-size: 16px; font-weight: bold; margin-bottom: 3px;">${bz.hour.ganzhi}</div>
                                <div style="color: #0ecb81; font-size: 10px;">${bz.hour.nayin}</div>
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="color: #f0b90b; font-size: 16px; margin: 20px 0 15px;">⚖️ 五行统计</h3>
                    <div style="background: #1e2329; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 14px;">${wuXingHTML}</div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #2b3139; color: #848e9c; font-size: 12px;">
                            日主: <span style="color: #f0b90b;">${bz.dayGan}</span> (${bz.strength})
                        </div>
                    </div>
                    
                    <h3 style="color: #f0b90b; font-size: 16px; margin: 20px 0 15px;">🎯 命理分析</h3>
                    <div style="background: #1e2329; padding: 15px; border-radius: 8px;">
                        <div style="margin-bottom: 10px;">
                            <span style="color: #848e9c; font-size: 12px;">格局：</span>
                            <span style="color: #eaecef; font-weight: bold;">${bz.pattern}</span>
                        </div>
                        <div>
                            <span style="color: #848e9c; font-size: 12px;">喜用神：</span>
                            <span style="color: #0ecb81;">${bz.god}</span>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧：大运和流年 -->
                <div>
                    <h3 style="color: #f0b90b; font-size: 16px; margin-bottom: 15px;">🌊 大运流转</h3>
                    <div style="background: #1e2329; border-radius: 8px; max-height: 280px; overflow-y: auto;">
                        ${dayunHTML}
                    </div>
                    
                    <h3 style="color: #f0b90b; font-size: 16px; margin: 20px 0 15px;">📆 流年运势</h3>
                    <div style="background: #1e2329; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                        ${liunianHTML}
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #2b3139; text-align: center; color: #848e9c; font-size: 11px;">
                💡 以上信息仅供参考，命运掌握在自己手中
            </div>
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(detailPanel);
    }

    // 自定义提示框
    function showCustomAlert(message, type = 'info') {
        // 移除已存在的提示框
        const existing = document.querySelectorAll('.custom-alert, .custom-alert-overlay');
        existing.forEach(el => el.remove());
        
        // 创建遮罩层
        const overlay = document.createElement('div');
        overlay.className = 'custom-alert-overlay';
        
        // 创建提示框
        const alertBox = document.createElement('div');
        alertBox.className = 'custom-alert';
        
        const icon = type === 'long' ? '🚀' : type === 'short' ? '😌' : '💡';
        const titleColor = type === 'long' ? colors.up : type === 'short' ? colors.down : '#f0b90b';
        
        alertBox.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 15px;">${icon}</div>
            <div style="color: ${titleColor}; font-size: 18px; font-weight: bold; margin-bottom: 10px;">
                ${type === 'long' ? '做多模式' : type === 'short' ? '躺平模式' : '提示'}
            </div>
            <div style="color: #eaecef; font-size: 14px; line-height: 1.6; white-space: pre-line;">
                ${message}
            </div>
            <button onclick="closeCustomAlert()" style="
                margin-top: 20px;
                padding: 8px 30px;
                background: ${titleColor};
                color: ${type === 'long' || type === 'short' ? 'white' : 'black'};
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
                transition: opacity 0.2s;
            " onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                确定
            </button>
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(alertBox);
        
        // 点击遮罩层也能关闭
        overlay.onclick = closeCustomAlert;
    }

    function closeCustomAlert() {
        const elements = document.querySelectorAll('.custom-alert, .custom-alert-overlay, .help-panel');
        elements.forEach(el => {
            el.style.animation = 'fadeOut 0.2s ease-out';
            setTimeout(() => el.remove(), 200);
        });
    }

    // 买入做多（努力）
    function doLong() {
        if (!currentDataset) {
            showCustomAlert('请先生成人生K线！', 'info');
            return;
        }
        
        const messages = [
            '已开启做多模式！\n未来5年运势预计上涨 +15%\n\n建议：加强学习和工作投入',
            '努力加持中...\n正能量满满，把握机会\n\n提示：天时地利人和，勇往直前',
            '财运、事业运将得到提升\n持续努力必有回报\n\n建议：制定明确目标并执行',
            '趋势向好，未来可期\n贵人运加持中...\n\n提示：主动出击，创造机会',
            '运势强劲，适合冲刺\n学习运旺，易有突破\n\n建议：投资自己，提升技能'
        ];
        
        const randomMsg = messages[Math.floor(Math.random() * messages.length)];
        showCustomAlert(randomMsg, 'long');
        
        // 模拟增加当前运势分数
        const currentScore = parseFloat(document.getElementById('current-score').innerText);
        const newScore = Math.min(95, currentScore + Math.random() * 3 + 1);
        document.getElementById('current-score').innerText = newScore.toFixed(2);
        document.getElementById('current-score').style.color = colors.up;
        
        // 添加脉冲动画
        const scoreEl = document.getElementById('current-score');
        scoreEl.classList.add('pulse');
        setTimeout(() => scoreEl.classList.remove('pulse'), 2000);
    }

    // 卖出做空（躺平）
    function doShort() {
        if (!currentDataset) {
            showCustomAlert('请先生成人生K线！', 'info');
            return;
        }
        
        const messages = [
            '已开启躺平模式\n适当休息也是一种智慧\n\n提示：给自己一段放空的时间',
            '放松中...\n顺其自然，静待花开\n\n建议：冥想、旅行或培养兴趣',
            '佛系生活启动\n平淡也是一种幸福\n\n提示：享受当下的宁静',
            '慢节奏模式\n有时候退一步海阔天空\n\n建议：整理思绪，蓄势待发',
            '休整期开启\n为下一次冲刺积蓄能量\n\n提示：张弛有度才能长久'
        ];
        
        const randomMsg = messages[Math.floor(Math.random() * messages.length)];
        showCustomAlert(randomMsg, 'short');
        
        // 模拟降低当前运势分数
        const currentScore = parseFloat(document.getElementById('current-score').innerText);
        const newScore = Math.max(20, currentScore - Math.random() * 2 - 0.5);
        document.getElementById('current-score').innerText = newScore.toFixed(2);
        document.getElementById('current-score').style.color = colors.down;
        
        // 添加脉冲动画
        const scoreEl = document.getElementById('current-score');
        scoreEl.classList.add('pulse');
        setTimeout(() => scoreEl.classList.remove('pulse'), 2000);
    }

    // 初始化时，需要有一个地方来放置格局和喜用神结果
    // 由于您的HTML中缺少这个区域，请确保您的HTML中有以下两个元素的占位符：
    // <div id="pattern-result"></div>
    // <div id="god-result"></div>

    document.addEventListener('DOMContentLoaded', () => {
        // 在顶部行情栏下方添加一个占位符，以便显示格局信息
        const header = document.querySelector('header');
        const infoBar = document.createElement('div');
        infoBar.className = 'flex gap-6 px-4 py-2 text-xs border-b border-[#2b3139] bg-[#1e2329] flex-shrink-0';
        infoBar.innerHTML = `
            <div onclick="showBaziDetail()" style="cursor: pointer;" class="hover:opacity-80 transition" title="点击查看详细信息">
                <div class="text-[#848e9c]">八字命盘 <span class="text-[10px]">▼</span></div>
                <div class="text-[#f0b90b] font-medium text-[11px]" id="bazi-result">未排盘</div>
            </div>
            <div>
                <div class="text-[#848e9c]">日主</div>
                <div class="text-white font-medium" id="strength-result">-</div>
            </div>
            <div>
                <div class="text-[#848e9c]">格局判定</div>
                <div class="text-white font-medium" id="pattern-result">未排盘</div>
            </div>
            <div>
                <div class="text-[#848e9c]">喜用神</div>
                <div class="text-[#0ecb81] font-medium" id="god-result">请点击生成</div>
            </div>
            <div style="margin-left: auto;">
                <div class="text-[#848e9c]">快捷键</div>
                <div class="text-[#848e9c] text-[10px]">D:日K | K:月K | Y:年K | A:MA | L:做多 | S:躺平 | H:帮助</div>
            </div>
            <div>
                <button onclick="toggleHelp()" class="px-3 py-1 rounded bg-[#2b3139] text-[#848e9c] text-xs hover:text-[#f0b90b] transition" title="帮助信息 (H键)">
                    ❓ 帮助
                </button>
            </div>
        `;
        header.parentNode.insertBefore(infoBar, header.nextSibling);

        // 初始化行情滚动条
        initTickerTape();
        
        // 初始化交易面板
        switchTradeTab('orderbook');
        
        runSimulation();
        
        // 添加键盘快捷键
        setupKeyboardShortcuts();
        
        // 定时更新行情
        setInterval(() => {
            // 随机更新行情数据
            tickerData.forEach(item => {
                const change = (Math.random() - 0.5) * 0.5;
                item.price = Math.max(10, item.price + change);
                const changePercent = ((Math.random() - 0.5) * 5).toFixed(2);
                item.change = (changePercent >= 0 ? '+' : '') + changePercent + '%';
                item.isUp = changePercent >= 0;
            });
            updateTickerTape();
        }, 3000);
    });

    // 缩放控制函数
    function zoomIn() {
        if (!chartInstance) return;
        chartInstance.dispatchAction({ type: 'dataZoom', dataZoomIndex: 0, type: 'dataZoom', end: Math.max(chartInstance.getOption().dataZoom[0].end - 10, 10) });
    }

    function zoomOut() {
        if (!chartInstance) return;
        chartInstance.dispatchAction({ type: 'dataZoom', dataZoomIndex: 0, type: 'dataZoom', end: Math.min(chartInstance.getOption().dataZoom[0].end + 10, 100) });
    }

    function resetZoom() {
        if (!chartInstance) return;
        chartInstance.dispatchAction({
            type: 'dataZoom',
            start: currentPeriod === '1y' ? 70 : 20,
            end: currentPeriod === '1y' ? 100 : 60
        });
    }

    // 帮助面板
    function toggleHelp() {
        const existing = document.querySelector('.help-panel');
        if (existing) {
            closeCustomAlert();
            return;
        }

        const overlay = document.createElement('div');
        overlay.className = 'custom-alert-overlay';
        overlay.onclick = closeCustomAlert;

        const helpPanel = document.createElement('div');
        helpPanel.className = 'help-panel';
        helpPanel.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #f0b90b; font-size: 20px; font-weight: bold;">📖 使用指南</h2>
                <button onclick="closeCustomAlert()" style="background: none; border: none; color: #848e9c; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
            </div>

            <div class="help-section">
                <h3>🎯 功能介绍</h3>
                <ul>
                    <li>完整的交易所界面：行情滚动、盘口深度、成交记录</li>
                    <li>以股票K线的形式展示人生运势走向</li>
                    <li>基于出生日期模拟八字排盘和命理分析</li>
                    <li>点击八字命盘可查看四柱、纳音、大运、流年详情</li>
                    <li>支持日K/月K/年K三种时间粒度查看</li>
                    <li>支持MA、EMA、BOLL等多种技术指标</li>
                    <li>多面板切换：盘口/成交/持仓/资产</li>
                    <li>杠杆交易模拟，支持开多/开空操作</li>
                    <li>24小时统计数据实时更新</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>⌨️ 键盘快捷键</h3>
                <ul>
                    <li><b>空格</b> - 重新生成人生K线</li>
                    <li><b>D</b> - 切换到日K粒度 (查看每天)</li>
                    <li><b>K</b> - 切换到月K粒度 (查看每月)</li>
                    <li><b>Y</b> - 切换到年K粒度 (查看每年)</li>
                    <li><b>A</b> - 切换MA均线指标</li>
                    <li><b>E</b> - 切换EMA指数移动平均</li>
                    <li><b>B</b> - 切换BOLL布林带</li>
                    <li><b>L</b> - 执行"做多"操作</li>
                    <li><b>S</b> - 执行"躺平"操作</li>
                    <li><b>1</b> - 切换到1年周期视图</li>
                    <li><b>2</b> - 切换到10年周期视图</li>
                    <li><b>Z</b> - 重置图表缩放</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>📊 图表操作</h3>
                <ul>
                    <li>鼠标滚轮 - 缩放图表</li>
                    <li>鼠标拖拽 - 平移图表</li>
                    <li>悬停K线 - 查看详细信息</li>
                    <li>点击右侧年份 - 快速跳转到对应时期</li>
                    <li>拖动底部滑块 - 精确调整显示区间</li>
                    <li><b>点击八字命盘</b> - 查看四柱、纳音、大运、流年详情</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>🔮 术语解释</h3>
                <ul>
                    <li><b>运势分数</b> - 当前人生状态评分(10-99)</li>
                    <li><b>四柱八字</b> - 年月日时四柱，每柱由天干地支组成</li>
                    <li><b>天干地支</b> - 中国古代纪年法，十天干配十二地支</li>
                    <li><b>日主</b> - 八字中代表自己的天干，身强身弱反映命局强弱</li>
                    <li><b>十神</b> - 比肩劫财食神伤官偏财正财七杀正官偏印正印</li>
                    <li><b>纳音</b> - 六十甲子纳音五行，如海中金、炉中火等</li>
                    <li><b>大运</b> - 每十年一个大运周期，影响人生运势走向</li>
                    <li><b>流年</b> - 每年的干支，与命局互动产生吉凶变化</li>
                    <li><b>格局判定</b> - 根据八字五行生克和十神关系判定命理格局</li>
                    <li><b>喜用神</b> - 对命局有利的五行属性，调候补益之神</li>
                    <li><b>精气神</b> - 生命活力指标（成交量）</li>
                    <li><b>做多/努力</b> - 积极奋进的人生态度</li>
                    <li><b>做空/躺平</b> - 放松休整的生活方式</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h3>📋 支持的格局类型</h3>
                <ul>
                    <li><b>特殊格局</b> - 从财格、从杀格、从儿格、专旺格、化气格等</li>
                    <li><b>正格</b> - 正官格、七杀格、正财格、偏财格、食神格、伤官格等</li>
                    <li><b>组合格</b> - 官印相生格、杀印相生格、财官双美格、食神生财格等</li>
                    <li><b>特色格</b> - 建禄格、阳刃格、伤官见官格、枭神夺食格等</li>
                    <li><b>共计30+种格局</b>，涵盖传统命理主要格局类型</li>
                </ul>
            </div>

            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #2b3139; text-align: center; color: #848e9c; font-size: 12px;">
                💡 提示：本应用仅供娱乐，不构成任何人生建议
            </div>
        `;

        document.body.appendChild(overlay);
        document.body.appendChild(helpPanel);
    }

    // 重置所有设置
    function resetAll() {
        // 重置日期和时辰
        document.getElementById('dob').value = '1998-08-08';
        document.getElementById('birth-hour').value = 'random';
        
        // 重置粒度为年K
        currentGranularity = 'year';
        document.getElementById('granularity-day').classList.remove('text-[#f0b90b]');
        document.getElementById('granularity-month').classList.remove('text-[#f0b90b]');
        document.getElementById('granularity-year').classList.add('text-[#f0b90b]');
        
        // 重置周期为1年
        currentPeriod = '1y';
        document.getElementById('period-1y').classList.add('text-[#f0b90b]');
        document.getElementById('period-10y').classList.remove('text-[#f0b90b]');
        
        // 重置指标，只保留MA
        activeIndicators = { ma: true, ema: false, boll: false };
        document.getElementById('indicator-ma').classList.add('text-[#f0b90b]');
        document.getElementById('indicator-ma').classList.remove('text-[#848e9c]');
        document.getElementById('indicator-ema').classList.add('text-[#848e9c]');
        document.getElementById('indicator-ema').classList.remove('text-[#d897cd]');
        document.getElementById('indicator-boll').classList.add('text-[#848e9c]');
        document.getElementById('indicator-boll').classList.remove('text-[#6885ce]');
        
        // 重置为八字排盘
        currentTab = 'bazi';
        document.getElementById('tab-bazi').classList.add('bg-[#2b3139]', 'text-white');
        document.getElementById('tab-bazi').classList.remove('text-[#848e9c]');
        document.getElementById('tab-ziwei').classList.remove('bg-[#2b3139]', 'text-white');
        document.getElementById('tab-ziwei').classList.add('text-[#848e9c]');
        
        // 重新生成
        runSimulation();
    }

    // 键盘快捷键
    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // 如果在输入框中，不触发快捷键
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            
            switch(e.key.toLowerCase()) {
                case ' ': // 空格键 - 生成K线
                    e.preventDefault();
                    runSimulation();
                    break;
                case 'd': // D键 - 日K粒度
                    switchGranularity('day');
                    break;
                case 'k': // K键 - 月K粒度 (M被MA占用)
                    switchGranularity('month');
                    break;
                case 'y': // Y键 - 年K粒度
                    switchGranularity('year');
                    break;
                case 'a': // A键 - 切换MA指标 (改用A代替M)
                    toggleIndicator('ma');
                    break;
                case 'e': // E键 - 切换EMA指标
                    toggleIndicator('ema');
                    break;
                case 'b': // B键 - 切换BOLL指标
                    toggleIndicator('boll');
                    break;
                case 'l': // L键 - 做多
                    doLong();
                    break;
                case 's': // S键 - 做空
                    doShort();
                    break;
                case '1': // 1键 - 1年周期
                    switchPeriod('1y');
                    break;
                case '2': // 2键 - 10年周期
                    switchPeriod('10y');
                    break;
                case 'z': // Z键 - 重置缩放
                    if (chartInstance) {
                        chartInstance.dispatchAction({
                            type: 'dataZoom',
                            start: currentPeriod === '1y' ? 70 : 20,
                            end: currentPeriod === '1y' ? 100 : 60
                        });
                    }
                    break;
                case 'h': // H键 - 帮助
                case '?': // ?键 - 帮助
                    toggleHelp();
                    break;
                case 'r': // R键 - 重置
                    resetAll();
                    break;
            }
        });
    }

    </script>
</body>
</html>